/*
 * Arethusa - a backend-independent client-side annotation framework
 * http://github.com/latin-language-toolkit/arethusa
 *
 * Version 0.2.5
 * built from branch mbrunet
 * at 708947366e315f6ce0185841a699607683fcbd07
 * on 2015-06-12T15:35:55.069Z
 *
 * Published under the MIT license
 */

"use strict";angular.module("arethusa.opendataNetwork",[]),angular.module("arethusa.opendataNetwork").directive("graphSetting",function(){return{restrict:"A",scope:{title:"@",value:"=",isInt:"@"},link:function(a,b,c){a.inputVal=angular.copy(a.value),a.save=function(){var b=angular.copy(a.inputVal);a.isInt&&(b=parseInt(b)),a.value=b}},templateUrl:"templates/arethusa.opendata_network/graph_setting.html"}}),angular.module("arethusa.opendataNetwork").directive("openDataEdge",["state","globalSettings",function(a,b){return{restrict:"AE",scope:{edge:"=",styles:"=",click:"@",hover:"@",highlight:"@"},link:function(a,b,c){a.label="+"},template:'        <span           menu-trigger="rightclick"           menu-position="bottom"            menu-obj="edge"           title="{{ edge.type }}"           >{{ label }}         </span>       '}}]),angular.module("arethusa.opendataNetwork").directive("openDataGraph",["graph",function(a){return{restrict:"A",scope:{tokens:"=",conf:"="},link:function(b,c,d){var e=new a(b,c,b.conf);e.launch()}}}]),angular.module("arethusa.opendataNetwork").factory("graph",["$compile","state","$timeout","keyCapture",function(a,b,c,d){return function(e,f,g){var h=this;h.configuration=g||{};var i=function(){var a=Object.keys(h.configuration.weight).map(function(a){return h.configuration.weight[a]});h.configuration.maxWeight=Math.max.apply(null,a)};h.configuration.defaultColor=h.configuration.defaultColor||"#999";{var j=15,k='        <svg class="full-height full-width">          <g transform="translate('+j+","+j+')"/>        </svg>      ',l=angular.element(k);d3.scale.category20(),new RegExp("([-0-9]+), ([-0-9]+)")}e.nodes={},e.links=[],e.annotations={},e.graph={nodes:[],links:[]},e.D3Params={charge:-200,linkDistance:100,running:!1,translate:{x:0,y:0},scale:1};var m=function(a,b){return e.D3Params.linkDistance*a.weight},n=function(a,b){return e.D3Params.charge*a.weight},o='          <span token="token"            style="white-space: nowrap;"            click="true"            hover="true"            />        ',p='          <span open-data-edge edge="edge"            style="white-space: nowrap;"            click="true"            hover="true"            />        ',q=function(){return h.svg.selectAll(function(){return this.getElementsByTagName("foreignObject")})},r=function(){return h.svg.selectAll("div.node.token-node")},s=function(){return h.svg.selectAll("div.edge.edge-node")},t=function(a){return h.svg.select('[data-node-id="'+a+'"]')},u=function(a,b){var c=0,d=0;try{c=b.children[0].width.baseVal.value,d=b.children[0].height.baseVal.value}catch(e){c=0,d=0}return"translate("+(a.x-c/2)+","+(a.y-d/2)+")"},v=function(a){var b=q();b.each(function(b,c,d){var e=this.getElementsByClassName(a);1===e.length&&(e=e[0],this.setAttribute("width",e.offsetWidth),this.setAttribute("height",e.offsetHeight))})},w=function(b){var c=e.$new();return h.childScopes.push(c),c.token=b,a(o)(c)[0]},x=function(b){var c=e.$new();return h.childScopes.push(c),c.edge=b,a(p)(c)[0]},y=function(a){var b="string"==typeof a?a:a.id;return"undefined"!=typeof e.nodes[b]};b.watch("graph",function(a,b,c){c.token;Q(),T()});var z=function(a,b){var c=b.target;y(c)||A(c),e.links.push(b)},A=function(a){var c=b.getToken(a);e.nodes[c.id]={name:c.string,token:c,id:c.id}},B=function(a){{var b=a.append("foreignObject").attr("overflow","visible").attr("width",1e4).attr("height",1e4);b.append("xhtml:div").html(function(a){return'<div class="node token-node placeholder" id="gtph'+a.token.id+'" style="display:inline;">'+a.token.string+"</div>"})}v("token-node");r().append(function(){return this.textContent="",w(e.nodes[this.id.slice(4)].token)})},C=function(a,b){var c=[],d=a.selectAll(".edgesLabels").data(b.links).enter().append("g").attr("text-anchor","middle");c.push(d);var f=d.append("text").attr("text-anchor","middle"),g=f.append("textPath").attr("class","edge edge-node placeholder").attr("xlink:href",function(a){return"#geph-path-"+a.id}).attr("id",function(a){return"geph"+a.id}).style("font-size","0.7em").attr("startOffset","25%").text(function(a){if(h.configuration.ontologyLabel){var b=a.type.split(":");return 2==b.length?b[1]:b}return a.type});if(c.push(g),!h.configuration.viewer){{var i=d.append("foreignObject").attr("overflow","visible").attr("width",1e4).attr("height",1e4);i.append("xhtml:div").style("display","inline").html(function(a){return'<div class="edge edge-node placeholder" id="geph'+a.id+'" style="display:inline;">'+h.configuration.defaultEdgeLabel+"</div>"})}v("edge-node");{s().append(function(){return this.textContent="",x(e.annotations[this.id.slice(4)])})}c.push(i)}return c},D=function(){var a={},b={nodes:[],links:[]},c=e.links.slice(),d={};e.annotations={};for(var f=c.length-1;f>=0;f--){var g=angular.copy(e.links[f]),i=g.source,j=g.target;if(h.configuration.mergeLinks===!0){var k=[i,j,g.type||g.id].join("-");if("undefined"!=typeof d[k]){"undefined"==typeof e.annotations[d[k]].alternativeIds&&(e.annotations[d[k]].alternativeIds=[]),e.annotations[d[k]].alternativeIds.push(g.id);continue}d[k]=g.id}if(e.annotations[g.id]=g,"undefined"==typeof a[i]){if("undefined"==typeof e.nodes[i])throw"";b.nodes.push(e.nodes[i]),a[i]=b.nodes.length-1}"undefined"==typeof a[j]&&(b.nodes.push(e.nodes[j]),a[j]=b.nodes.length-1),b.links.push(g);var l=b.links.length-1;b.links[l].source=a[i],b.links[l].target=a[j],b.links[l].value=g.weight}return b},E=function(){h.g&&h.g.selectAll("*").remove()},F=function(a,b){"undefined"!=typeof a?(e.D3Params.translate.x=e.D3Params.translate.x+parseInt(a),e.D3Params.translate.y=e.D3Params.translate.y+parseInt(b)):(e.D3Params.translate.x=0,e.D3Params.translate.y=0),K()};e.graphMove=F;var G=function(a){e.D3Params.scale="undefined"==typeof a?1:e.D3Params.scale*parseFloat(a),K()};e.graphZoom=G;var H=function(a){if(a){var b=J(a),c=I(),d={x:c.realCenter.x-b.x,y:c.realCenter.y-b.y};F(d.x,d.y)}},I=function(){var a=l.width(),b=l.height();return{width:a,height:b,center:{x:a/2,y:b/2},realCenter:{x:a/2-e.D3Params.translate.x,y:b/2-e.D3Params.translate.y}}},J=function(a){var b=a.attr("transform"),c=/translate\((.*),(.*?)\)/.exec(b);return{x:c[1],y:c[2]}};e.focusSelection=function(){var a=b.firstSelected();a&&H(angular.element(t(a)[0][0]))};var K=function(){d3.event&&null!==d3.event.scale&&(e.D3Params.scale=d3.event.scale);var a=h.g.select("g.graphContainer");a.attr("transform","translate("+e.D3Params.translate.x+", "+e.D3Params.translate.y+")scale("+e.D3Params.scale+")")},L=function(){return e.D3Params.displayLabels=!e.D3Params.displayLabels,e.D3Params.displayLabels?(h.edgeLabels.label.attr("opacity","1"),h.edgeLabels.links.attr("opacity","0")):(h.edgeLabels.label.attr("opacity","0"),h.edgeLabels.links.attr("opacity","1")),e.D3Params.displayLabels};e.toggleLabels=L;var M=function(a){O(a);var b,c;h.svg=d3.select(f[0]),b=h.g=h.svg.select("g");var d=b.append("g").attr("class","graphContainer");d.call(d3.behavior.zoom().on("zoom",K));var g=d.append("g").attr("class","nodes"),j=d.append("g").attr("class","links"),k=d.append("g").attr("class","edge-labels");c=h.force=d3.layout.force().charge(n).linkDistance(m).size([l.width(),l.height()]),c.nodes(a.nodes).links(a.links).start(),e.D3Params.running=!0;var o=j.selectAll(".link").data(a.links).enter().append("path").attr("class","link").attr("id",function(a){return"geph-path-"+a.id}).style("stroke-width",function(a){if("undefined"!=typeof h.configuration.weight){"undefined"==typeof h.configuration.maxWeight&&i();var b=a.type;if("undefined"!=typeof h.configuration.weight[b])return 1*h.configuration.maxWeight/h.configuration.weight[b]}return Math.sqrt(a.value)});"undefined"!=typeof h.configuration.colors&&o.style("stroke",function(a){var b=a.type;return"undefined"!=typeof h.configuration.colors[b]?h.configuration.colors[b]:h.configuration.defaultColor});var p=g.selectAll(".node").data(a.nodes).enter().append("g").attr("class","node").attr("overflow","visible").attr("data-node-id",function(a){return a.id}).call(c.drag),q=(B(p),C(k,a));h.edgeLabels={container:q[0],label:q[1],links:q[2]},h.configuration.viewer||h.edgeLabels.label.attr("opacity","0");var r=P(a);c.on("tick",function(){var a={};o.attr("d",function(b){var c=N(b,a,r);return"M"+b.source.x+","+b.source.y+"A"+c+","+c+" 0 0 1,"+b.target.x+","+b.target.y+"A"+c+","+c+" 0 0 0,"+b.source.x+","+b.source.y}),h.configuration.viewer||h.edgeLabels.links.attr("transform",function(b){var c=N(b,a,r),d=SVGCurveLib.pointOnEllipticalArc({x:b.source.x,y:b.source.y},c,c,0,0,1,{x:b.target.x,y:b.target.y},.5);return u(d,this)}),p.attr("transform",function(a){return u(a,this)})})},N=function(a,b,c){if(b[a.id])return b[a.id];var d=a.target.x-a.source.x,e=a.target.y-a.source.y,f=Math.sqrt(d*d+e*e),g=c[a.source.id+","+a.target.id]||c[a.target.id+","+a.source.id];return g>1&&(f/=1+1/g*(a.linkindex-1)),b[a.id]=f,f},O=function(a){a.links.sort(function(a,b){return a.source>b.source?1:a.source<b.source?-1:a.target>b.target?1:a.target<b.target?-1:0})},P=function(a){for(var b={},c=0;c<a.links.length;c++)a.links[c].linkindex=0!==c&&a.links[c].source==a.links[c-1].source&&a.links[c].target==a.links[c-1].target?a.links[c-1].linkindex+1:1,void 0!==b[a.links[c].target.id+","+a.links[c].source.id]?b[a.links[c].target.id+","+a.links[c].source.id]=a.links[c].linkindex:b[a.links[c].source.id+","+a.links[c].target.id]=a.links[c].linkindex;return b},Q=function(){e.nodes={},e.links=[],e.annotations={},e.graph={nodes:[],links:[]},angular.forEach(e.tokens,function(a,b){y(a)||A(a.id);for(var c=a.graph.length-1;c>=0;c--)z(a.id,a.graph[c])})},R=function(a){return"templates/arethusa.opendata_network/"+a+".html"},S=function(b){var c='<span class="right" ng-include="'+b+'"/>';angular.element(f[0].previousElementSibling).append(a(c)(e))};e.panelTemplate=R("opendata_settings");var T=function(){h.svg||(f.append(l),S("panelTemplate"));var a=D();a.nodes.length>=2&&(E(),M(a))};h.childScopes=[];var U=function(){return f.parents(".gridster")},V=function(){return U().length},W=function(){return U().hasClass("gridster-loaded")};this.launch=function(){Q(),V()&&!W()?c(T,130):T()};var X=function(a){parseInt(a);e.D3Params.charge=e.D3Params.charge+a},Y=function(a){parseInt(a);e.D3Params.linkDistance=e.D3Params.linkDistance+a},Z=function(){e.D3Params.running=!e.D3Params.running,e.D3Params.running===!0?h.force.resume():h.force.stop()};e.forceToggle=Z,e.$watch("D3Params.linkDistance",function(a,b,c){a!==b&&h.force.stop().linkDistance(m).start()}),e.$watch("D3Params.charge",function(a,b,c){a!==b&&h.force.stop().charge(n).start()});var $=function(a){return{tree:[a.create("graphLeft",function(){F(-20,0)},"q"),a.create("graphCenter",function(){F()},"s"),a.create("graphRight",function(){F(20,0)},"d"),a.create("graphTop",function(){F(0,20)},"z"),a.create("graphBottom",function(){F(0,-20)},"x"),a.create("forceChargePlus",function(){X(10)},"f"),a.create("forceChargeMinus",function(){X(-10)},"c"),a.create("linkDistancePlus",function(){Y(10)},"g"),a.create("linkDistanceMinus",function(){Y(-10)},"v"),a.create("forceToggle",function(){Z()},"p"),a.create("focusNode",function(){e.focusSelection()},"a")]}},_=d.initCaptures($);e.keyHints=arethusaUtil.inject({},_.tree,function(a,b,c){a[b]=arethusaUtil.formatKeyHint(c)}),e.$on("$destroy",_.$destroy)}}]),angular.module("arethusa.opendataNetwork").service("opendataNetwork",["state","configurator","globalSettings","notifier","translator",function(a,b,c,d,e){var f=this;this.name="opendataNetwork",this.externalDependencies={ordered:["bower_components/d3/d3.min.js","bower_components/svg-curve-lib/src/js/svg-curve-lib.js"]},this.defaultConf={template:"templates/arethusa.opendata_network/opendata_network.html",multipleLinks:!1,mergeLinks:!1,edgeLabel:!1,ontologyLabel:!1,defaultEdgeLabel:"+",color:{},weight:{}};var g={},h=function(){b.getConfAndDelegate(f)},i=function(a,b){return a.linkCounter+"_"+a.id+"_"+b},j=function(a,b){return{id:i(a,b.id),target:b.id,source:a.id,weight:1,type:null,group:0}},k=function(b,c){var d=j(b,c);b.linkCounter=b.linkCounter+1,b.graph.push(d);var e=b.graph;a.change(b,"graph",e)},l=function(a){f.changeLink(a)},m=function(b,c){return!a.isSelected(b)&&a.hasClickSelections()&&!c.ctrlKey},n=function(){return{mouseenter:function(a,b,c){m(a,c)&&b.addClass("copy-cursor")},mouseleave:function(a,b,c){b.removeClass("copy-cursor")}}},o=function(){angular.forEach(a.tokens,q)},p=function(a){return"undefined"!=typeof a.graph&&a.graph.length>0},q=function(a){p(a)||(a.graph=[],a.linkCounter=a.graph.length),"undefined"==typeof a.linkCounter&&(a.linkCounter=a.graph.length)};f.disconnect=function(a){};var r=function(b){var c,d=b.sentenceId,e=b.id,f=[];for(var g in a.clickedTokens){var h=a.getToken(g);if(h.sentenceId!==d){c=!0;break}e!==g&&f.push(h)}return c?"err":f.length?f:!1};this.changeLink=function(b){var c=angular.isString(b)?a.getToken(b):b,e=r(c);return e?"err"===e?void d.error(g.errorAcrossSentences):(a.doBatched(function(){angular.forEach(e,function(a,b){k(a,c)})}),!0):!1},a.on("tokenAdded",function(a,b){q(b)}),a.on("tokenRemoved",function(b,c){p(c)&&f.disconnect(c);var d=c.id;angular.forEach(a.tokens,function(a,b){a.head.id===d&&f.disconnect(a)})});var s="change connection";c.addClickAction(s,l,n()),this.init=function(){h(),o(),"editor"===f.mode&&c.setClickAction(s)}}]),angular.module("arethusa.opendataNetwork").run(["$templateCache",function(a){a.put("templates/arethusa.opendata_network/graph_setting.html",'<span>\n  <span class="note">{{ title }}</span>\n  <input style="display: inline; height: 1.2rem; width: 3rem; padding:0rem; font-size:0.6rem; margin:0;" type="text" ng-model="inputVal"/> \n  <span class="note" ng-click="save()"><i class="fa fa-save"></i></span>\n</span>\n\n'),a.put("templates/arethusa.opendata_network/opendata_network.html",'<div class="tree-canvas">\n  <div class="tree-settings">\n    <span token-selector="state.tokens"></span>\n  </div>\n  <div\n    open-data-graph\n    conf="plugin.conf"\n    tokens="state.tokens"\n    to-bottom\n  >\n  </div>\n</div>\n'),a.put("templates/arethusa.opendata_network/opendata_settings.html",'<span\n  title="Zoom Out"\n  class="settings-span-button"\n  ng-click="graphZoom(0.9)">\n  <i class="fa fa-search-minus"></i>\n</span><span\n  title="Zoom In"\n  class="settings-span-button"\n  ng-click="graphZoom(1.1)">\n  <i class="fa fa-search-plus"></i>\n</span><span\n  title="Original Zoom"\n  class="settings-span-button"\n  ng-click="graphZoom()">\n  <i class="fa fa-search"></i>\n</span><span\n  title="Move"\n  class="settings-span-button"\n  jqyoui-draggable="{onDrag:\'draggingGraph()\'}">\n  <i class="fa fa-arrows"></i>\n</span><span\n  title="Move to left"\n  class="settings-span-button"\n  ng-click="graphMove(-20, 0)">\n  <i class="fa fa-arrow-circle-left"></i>\n</span><span\n  title="Move to left"\n  class="settings-span-button"\n  ng-click="graphMove(20, 0)">\n  <i class="fa fa-arrow-circle-right"></i>\n</span><span\n  title="Move to left"\n  class="settings-span-button"\n  ng-click="graphMove(0, 20)">\n  <i class="fa fa-arrow-circle-up"></i>\n</span><span\n  title="Move to left"\n  class="settings-span-button"\n  ng-click="graphMove(0, -20)">\n  <i class="fa fa-arrow-circle-down"></i>\n</span>\n<span\n  title="Centrer l\'arbre"\n  class="settings-span-button"\n  ng-click="graphMove()">\n  <i class="fa fa-dot-circle-o"></i>\n</span>\n<span\n  title="Pause"\n  class="settings-span-button"\n  ng-click="forceToggle()">\n  <i class="fa" ng-class="{\'fa-pause\':D3Params.running, \'fa-play\':D3Params.running===false}"></i>\n</span>\n<span\n  title="{{ translations.focusSel() }} {{ keyHints.focusSelection}}"\n  class="settings-span-button"\n  ng-click="focusSelection()">\n  <i class="fi-target-two rotate-on-hover"></i>\n</span>\n<span\n  title="{{ translations.focusSel() }} {{ keyHints.focusSelection}}"\n  class="settings-span-button"\n  ng-click="toggleLabels()">\n  <i class="fa" ng-class="{\'fa-eye\':!D3Params.displayLabels,\'fa-eye-slash\':D3Params.displayLabels}"></i>\n</span>\n<span ng-click="advancedSettings = !advancedSettings"><i class="fa fa-gear rotate-on-hover"></i></span>\n<div ng-show="advancedSettings">\n  <div class="right" style="text-align: right;">\n    <div><span graph-setting is-int="true" value="D3Params.charge" title="Charge"></span></div>\n    <div><span graph-setting is-int="true" value="D3Params.linkDistance" title="Link Distance"></span></div>\n  </div>\n</div>')}]);
//# sourceMappingURL=arethusa.opendata_network.min.map